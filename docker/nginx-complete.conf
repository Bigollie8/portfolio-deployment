events {
    worker_connections 1024;
}

http {
    upstream portfolio {
        server portfolio-backend:3001;
    }

    upstream shipping {
        server shipping-backend:3003;
    }

    upstream security {
        server security-backend:8000;
    }

    upstream photos {
        server photos-backend:8080;
    }

    upstream photos-ai {
        server photos-ai:3002;
    }

    upstream status {
        server status-page:3004;
    }

    # Status Page - dedicated server for status.basedsecurity.net
    server {
        listen 80;
        server_name status.basedsecurity.net;

        location / {
            proxy_pass http://status;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # API Gateway - main server for api.basedsecurity.net (default)
    server {
        listen 80 default_server;
        server_name api.basedsecurity.net _;

        # Increase body size for photo uploads
        client_max_body_size 100M;

        # Health check endpoint
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        # Portfolio API - /portfolio/* -> portfolio-backend
        location /portfolio/ {
            proxy_pass http://portfolio/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Shipping API - /shipping/* -> shipping-backend
        location /shipping/ {
            proxy_pass http://shipping/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Security API - /security/* -> security-backend
        location /security/ {
            proxy_pass http://security/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Photos API - /photos/* -> photos-backend
        location /photos/ {
            proxy_pass http://photos/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
        }

        # Photos AI API - /photos-ai/* -> photos-ai service
        location /photos-ai/ {
            proxy_pass http://photos-ai/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 120;
            proxy_send_timeout 120;
            proxy_read_timeout 120;
        }

        # Status Page - /status/* -> status-page service
        location /status/ {
            proxy_pass http://status/;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Default - 404
        location / {
            return 404 'API endpoint not found';
            add_header Content-Type text/plain;
        }
    }
}
